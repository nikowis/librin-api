<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                      http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.8.xsd">

    <changeSet id="changeset2020-08-29-cities-books.xml" author="nikowis">
        <sql>
            CREATE TABLE "city" (
                id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY
                , name VARCHAR(64) NOT NULL
                , voivodeship VARCHAR(32) NOT NULL
                , display_name VARCHAR(128) NOT NULL
                , type VARCHAR(16) NOT NULL
            );
            CREATE INDEX CITY_NAME_IDX ON "city" ("name");


            CREATE TABLE "book" (
                id VARCHAR(32) PRIMARY KEY
                , author VARCHAR(128) NOT NULL
                , title VARCHAR(128) NOT NULL
                , subtitle VARCHAR(128) NULL
                , datestamp VARCHAR(32) NOT NULL
            );

            --https://stackoverflow.com/questions/11005036/does-postgresql-support-accent-insensitive-collations/11007216#11007216
            CREATE OR REPLACE FUNCTION public.f_unaccent(text)
            RETURNS text AS
            $func$
            SELECT public.unaccent('public.unaccent', $1)  -- schema-qualify function and dictionary
            $func$  LANGUAGE sql IMMUTABLE PARALLEL SAFE STRICT;

            --SELECT * FROM book WHERE lower(public.f_unaccent(title)) LIKE lower(public.f_unaccent('%Potter%'));
            CREATE INDEX BOOK_TITLE_IDX ON book USING GIN(lower(public.f_unaccent(title)) gin_trgm_ops);
            CREATE INDEX BOOK_AUTHOR_IDX ON book USING GIN(lower(public.f_unaccent(author)) gin_trgm_ops);

        </sql>
    </changeSet>
</databaseChangeLog>



